import{H as ke,J as $e,K as be,r as y,L as xe,w as z,N as Se,O as we,k as b,d as Ee,P as Ne,m as Re,Q as Oe,b as T,e as De,c as v,h as O,n as u,l as D,a as $,t as G,F as J,j as U,s as Ce,i as X,u as Te,v as Le,R as ie,T as re,p as le,o as d,S as Ae,A as ue,U as Ie,C as Me,g as ce,q as Pe,W as te,X as We,Y as Fe,Z as j,$ as de,a0 as Y,a1 as _e,a2 as fe,_ as Be}from"./index-4bb58793.js";import{E as Ve}from"./index-bc918f74.js";import{L as je}from"./index-ca28e5c1.js";import{F as ze}from"./index-d9c5e50f.js";function ee(n){return Se()?(we(n),!0):!1}function se(n){return typeof n=="function"?n():b(n)}const H=typeof window<"u"&&typeof document<"u",He=typeof WorkerGlobalScope<"u"&&globalThis instanceof WorkerGlobalScope,qe=Object.prototype.toString,Ge=n=>qe.call(n)==="[object Object]",ve=()=>{};function Je(...n){if(n.length!==1)return ke(...n);const s=n[0];return typeof s=="function"?$e(be(()=>({get:s,set:ve}))):y(s)}function Ue(n,s=1e3,_={}){const{immediate:h=!0,immediateCallback:N=!1}=_;let f=null;const x=y(!1);function L(){f&&(clearInterval(f),f=null)}function A(){x.value=!1,L()}function g(){const i=se(s);i<=0||(x.value=!0,N&&n(),L(),f=setInterval(n,i))}if(h&&H&&g(),xe(s)||typeof s=="function"){const i=z(s,()=>{x.value&&H&&g()});ee(i)}return ee(A),{isActive:x,pause:A,resume:g}}function Ze(n){var s;const _=se(n);return(s=_==null?void 0:_.$el)!=null?s:_}const Ke=H?window:void 0;function Qe(...n){let s,_,h,N;if(typeof n[0]=="string"||Array.isArray(n[0])?([_,h,N]=n,s=Ke):[s,_,h,N]=n,!s)return ve;Array.isArray(_)||(_=[_]),Array.isArray(h)||(h=[h]);const f=[],x=()=>{f.forEach(i=>i()),f.length=0},L=(i,l,c,S)=>(i.addEventListener(l,c,S),()=>i.removeEventListener(l,c,S)),A=z(()=>[Ze(s),se(N)],([i,l])=>{if(x(),!i)return;const c=Ge(l)?{...l}:l;f.push(..._.flatMap(S=>h.map(I=>L(i,S,I,c))))},{immediate:!0,flush:"post"}),g=()=>{A(),x()};return ee(g),g}const me="ping";function ne(n){return n===!0?{}:n}function Xe(n,s={}){const{onConnected:_,onDisconnected:h,onError:N,onMessage:f,immediate:x=!0,autoClose:L=!0,protocols:A=[]}=s,g=y(null),i=y("CLOSED"),l=y(),c=Je(n);let S,I,p=!1,C=0,R=[],k;const Z=()=>{if(R.length&&l.value&&i.value==="OPEN"){for(const r of R)l.value.send(r);R=[]}},M=()=>{clearTimeout(k),k=void 0},P=(r=1e3,m)=>{!H||!l.value||(p=!0,M(),S==null||S(),l.value.close(r,m),l.value=void 0)},F=(r,m=!0)=>!l.value||i.value!=="OPEN"?(m&&R.push(r),!1):(Z(),l.value.send(r),!0),q=()=>{if(p||typeof c.value>"u")return;const r=new WebSocket(c.value,A);l.value=r,i.value="CONNECTING",r.onopen=()=>{i.value="OPEN",_==null||_(r),I==null||I(),Z()},r.onclose=m=>{if(i.value="CLOSED",h==null||h(r,m),!p&&s.autoReconnect){const{retries:w=-1,delay:B=1e3,onFailed:V}=ne(s.autoReconnect);C+=1,typeof w=="number"&&(w<0||C<w)||typeof w=="function"&&w()?setTimeout(q,B):V==null||V()}},r.onerror=m=>{N==null||N(r,m)},r.onmessage=m=>{if(s.heartbeat){M();const{message:w=me}=ne(s.heartbeat);if(m.data===w)return}g.value=m.data,f==null||f(r,m)}};if(s.heartbeat){const{message:r=me,interval:m=1e3,pongTimeout:w=1e3}=ne(s.heartbeat),{pause:B,resume:V}=Ue(()=>{F(r,!1),k==null&&(k=setTimeout(()=>{P(),p=!1},w))},m,{immediate:!1});S=B,I=V}L&&(H&&Qe("beforeunload",()=>P()),ee(P));const K=()=>{!H&&!He||(P(),p=!1,C=0,q())};return x&&K(),{data:g,status:i,close:P,send:F,open:K,ws:l}}const Ye=["data-hidden","data-notify"],et=["data-notify"],tt=["data-notify"],nt={key:0,class:"ark-text_body-xs ark-text_64"},st=["title","data-active","onClick"],at={key:1,class:"ark-text_body-xs ark-text_semibold ark-text_64",style:{"text-align":"center","padding-top":"0.5rem"}},ot={style:{width:"100%"}},it=["title"],rt=$("p",{class:"ark-space_bottom-1"},"Не удалось загрузить историю",-1),lt=Ee({__name:"RestaurantRoot",props:{id:{}},setup(n){const s=n,h=Ne().computedSmallerThen("mobile"),N=Le(),f=Te(),x=Re(),L=f.authorized,A=y(Date.now()),g=y(!1),i=y(!1),l=y(Date.now()),c=y(!0),S=y([]),I=y([]),p=Oe({}),C=y(!1),R=y(null),k=T(()=>{const e=R.value;return e?p[e]||[]:[]}),Z=T(()=>{const e=S.value;return[null].concat(e)}),M=T(()=>I.value.filter(e=>e.has_bookings)),P=T(()=>M.value.sort((t,E)=>t.code-E.code)),F=T(()=>{if(!c.value)return!1;const e=Object.values(p);return e.length>0&&e.some(t=>t.length>0)}),q=T(()=>{const e=M.value;return e.length>0&&!!e.find(t=>`${t.code}`===s.id)}),K=T(()=>{const e=M.value;return e.length>0&&!!e.find(t=>`${t.code}`===s.id)&&N.currentRoute.value.path.includes("/booking")});De(()=>{f.loadRestaurants.execute().then(e=>{I.value=e||[]}).catch(()=>null)}),ie(We,A),ie(Fe,Z),z(()=>s.id,e=>{e&&f.loadZones.execute({id:e}).then(t=>{S.value=(t==null?void 0:t.zones)||[]}).catch(()=>{x.show("Попробуйте обновить страницу",{type:"error",label:"Не удалось загрузить зоны ресторана"})})},{immediate:!0});const r={111113:new j(10,0)},m=e=>{const[t]=e.time_from.split("+"),[E]=e.time_to.split("+"),a=r[e.restaurant]||new j(0,0),o=new Date(new de(Y.jsonParse(t),j.fromString(t.split("T")[1])).valueOf()+_e*a.hours+fe*a.minutes),W=`${Y.fromLocalNativeDate(o).toJSON()}T${j.fromLocalNativeDate(o).toString("HH:MM:SS")}+${a.toString()}`,oe=new Date(new de(Y.jsonParse(E),j.fromString(E.split("T")[1])).valueOf()+_e*a.hours+fe*a.minutes),ge=`${Y.fromLocalNativeDate(oe).toJSON()}T${j.fromLocalNativeDate(oe).toString("HH:MM:SS")}+${a.toString()}`;return{name_for_reservation:e.name,restaurant:e.restaurant,id:e.id_airesto,seating_time:W,end_time:ge,status:e.status}},w=e=>{},B=()=>{C.value=!1},V=(e,t)=>{const E=t.data;let a=null;try{a=JSON.parse(E)}catch{}if(a)if(a&&"id_airesto"in a)if(a.status===re.NEW){let o=!1;p[a.restaurant]=p[a.restaurant].map(W=>W.id===a.id_airesto?(o=!0,m(a)):W),o||(p[a.restaurant]=p[a.restaurant].concat(m(a)))}else p[a.restaurant]=p[a.restaurant].filter(o=>o.id!==a.id_airesto);else a&&a.fingerprint==="init"&&(C.value=!0)},pe=()=>{C.value=!1},ye="wss://notify.airesto.ru",ae=T(()=>L.value&&M.value.length>0?`${ye}/ws?token=${localStorage.getItem("__ark-supra-at")}`:void 0),Q=Xe(ae,{onConnected:w,onDisconnected:B,onMessage:V,autoReconnect:{retries:1e3,delay:5e3,onFailed:pe},immediate:!1});z(ae,e=>{e?Q.open():Q.close()},{immediate:!0}),z([R,l],([e])=>{e!==null&&(g.value=!0,i.value=!1,f.loadBooking.execute({status:re.NEW,restaurant_id:`${e}`}).then(t=>{t&&(p[e]=t,g.value=!1)}).catch(()=>{i.value=!0,g.value=!1}))},{immediate:!0});const he=T(()=>Q.status.value);return z([he,M],([e,t])=>{if(e==="OPEN"&&t.length>0){const E=t.map(a=>a.code);R.value=E[0],Q.send(JSON.stringify({type:"restaurants",restaurants:E,fingerprint:"init"}))}},{immediate:!0}),(e,t)=>{const E=le("RouterView"),a=le("RouterLink");return d(),v(J,null,[O(E),q.value?(d(),v("div",{key:0,class:u(e.$style.safe)},null,2)):D("",!0),K.value?(d(),v("div",{key:1,class:u(e.$style.fixed),"data-hidden":c.value,"data-notify":F.value},[$("div",{class:u(e.$style.fixed__header),onClick:t[1]||(t[1]=o=>c.value=!c.value)},[b(h)&&c.value?(d(),v("div",{key:0,class:u(e.$style.fixed__mobile)},[$("span",{class:u(e.$style.fixed__title),style:{font:"var(--ark-font-xs)","padding-right":"0","font-weight":"600"},"data-notify":F.value}," Брони ",10,et),k.value.length?(d(),v("span",{key:0,class:u(e.$style.fixed__count)},G(k.value.length),3)):D("",!0)],2)):(d(),v(J,{key:1},[$("p",{class:u(e.$style.fixed__title),"data-notify":F.value},[U(" Бронирования "),O(b(Ae),{class:"ark-text_48",size:12,name:C.value?"check":"spinner"},null,8,["name"])],10,tt),k.value.length>0?(d(),v("p",nt,[U(" Необходимо подтверждение "),k.value.length?(d(),v("span",{key:0,class:u(e.$style.fixed__count)},G(k.value.length),3)):D("",!0)])):D("",!0),$("div",{class:u(e.$style.fixed__close)},[O(b(ue),{"icon-button":"",icon:"arrow-down",appearance:"flat",size:"xs",shape:"square",rotate:c.value,onClick:t[0]||(t[0]=Ce(o=>c.value=!c.value,["stop","prevent"]))},null,8,["rotate"])],2)],64))],2),O(b(Ve),{opened:!c.value},{default:X(()=>[O(b(Ie),{style:{height:"240px"}},{default:X(()=>[P.value.length>1?Me((d(),v("div",{key:0,class:u(e.$style.rests)},[(d(!0),v(J,null,ce(P.value,o=>(d(),v("button",{key:o.code,type:"button",title:o.name,class:u(e.$style.rests__item),"data-active":R.value===o.code,onClick:W=>R.value=o.code},[$("p",{class:u(e.$style.rests__name)},G(o.name),3),$("p",null,G(o.code),1)],10,st))),128))],2)),[[b(ze)]]):D("",!0),C.value?D("",!0):(d(),v("p",at,[U(" Подключаемся"),O(b(je))])),k.value.length>0?(d(),v(J,{key:2},[(d(!0),v(J,null,ce(k.value,(o,W)=>(d(),Pe(a,{key:W,class:u(e.$style.fixed__item),to:{path:`/restaurant/${o.restaurant}/booking`,query:{...e.$route.query,bookingid:o.id}}},{default:X(()=>[$("div",ot,[$("p",{title:o.name_for_reservation,class:u(e.$style.item__name)},G(o.name_for_reservation),11,it),$("div",{class:u(e.$style.item__date)},[$("div",{class:u(e.$style.item__date)},[O(b(te),{mask:"[hour:numeric]:[minute:numeric] ",date:o.seating_time},null,8,["date"]),U(" ‐ "),O(b(te),{mask:" [hour:numeric]:[minute:numeric]",date:o.end_time},null,8,["date"])],2),O(b(te),{today:"",mask:"[day:numeric] [month:long] [year:numeric]",date:o.seating_time},null,8,["date"])],2)])]),_:2},1032,["class","to"]))),128)),$("div",{class:u([e.$style.fixed__item,e.$style.fixed__item_all])}," Пока что все ",2)],64)):D("",!0),k.value.length===0?(d(),v("div",{key:3,class:u([e.$style.fixed__item,e.$style.fixed__item_desc])}," Здесь будут бронирования которые требуют подтверждения ",2)):D("",!0),i.value?(d(),v("div",{key:4,class:u([e.$style.fixed__item,e.$style.fixed__item_desc])},[$("div",null,[rt,O(b(ue),{size:"xs",appearance:"neutral",onClick:t[2]||(t[2]=o=>l.value=Date.now())},{default:X(()=>[U(" Попробуй еще раз ")]),_:1})])],2)):D("",!0)]),_:1})]),_:1},8,["opened"])],10,Ye)):D("",!0)],64)}}}),ut="_safe_n017n_1",ct="_fixed_n017n_5",dt="_fixed__title_n017n_16",_t="_fixed__count_n017n_38",ft="_fixed__header_n017n_46",mt="_fixed__close_n017n_51",vt="_fixed__item_n017n_56",pt="_fixed__item_all_n017n_68",yt="_fixed__item_desc_n017n_73",ht="_fixed__mobile_n017n_79",gt="_supraPulseAnimation_n017n_1",kt="_item__name_n017n_104",$t="_item__date_n017n_111",bt="_rests_n017n_118",xt="_rests__item_n017n_132",St="_rests__name_n017n_153",wt={safe:ut,fixed:ct,fixed__title:dt,fixed__count:_t,fixed__header:ft,fixed__close:mt,fixed__item:vt,fixed__item_all:pt,fixed__item_desc:yt,fixed__mobile:ht,supraPulseAnimation:gt,item__name:kt,item__date:$t,rests:bt,rests__item:xt,rests__name:St},Et={$style:wt},Ct=Be(lt,[["__cssModules",Et]]);export{Ct as default};
